\newif\iffull
\newif\ifnotes
\newif\iflabels
\newif\ifanonymous
\newif\ifspace
\newif\ifcameraready
\newif\ifbibtex

%%% Settings
%% Full version of the paper
\fulltrue
%% Show notes and todos
\notestrue
%% Print labels in the margins
% \labelstrue
%% Hide authors
% \anonymoustrue
%% Enable hacks to save space
% \spacetrue
%% Disable some tweaks that the publisher may not like
% \camerareadytrue
%% Use legacy BibTeX instead of Biber
% \bibtextrue

\ifcameraready\iffull
  \GenericError{}{crypto-template Error: \protect\fulltrue\space is incompatible with \protect\camerareadytrue}%
  {See the settings at the top of \jobname.tex.}{Set either \protect\fullfalse\space or \protect\camerareadyfalse\space.}%
\fi\fi

%%% Document class
\ifcameraready
  % Disable all patching done by llncsstandalone and use plain llncs
  \PassOptionsToClass{nostandalone}{llncsstandalone}
\else
  % Adjust margins for "big" paper
  \PassOptionsToClass{adjustmargins}{llncsstandalone}
\fi
\documentclass[
  % Pass either "a4paper" or "letterpaper" explicitly.
  % (If the paper size is not specified, it will depend on the default
  % set in the (La)TeX installation.)
  a4paper,
  orivec,oribibl]{llncsstandalone}

%% Uncomment to set margins manually (see the geometry package).
% \geometry{textwidth=150mm, textheight=237mm, vmarginratio=5:7, footskip=14mm}

\usepackage[save]{silence}
\usepackage[T1]{fontenc}
\usepackage{lmodern}

%%% Space savings.
%%% The evil stuff. Uncomment manually.
\ifspace
  %% Scale line spacing. This becomes apparent at ~0.985 and below.
  % \renewcommand\baselinestretch{0.99}
  %% Always use inline style for \sum, \prod, ...
  % \PassOptionsToPackage{nosumlimits}{amsmath}
\fi

%%% Misc early packages
\usepackage[english]{babel}
\usepackage{csquotes}
\usepackage[babel,final]{microtype}
\usepackage{xpunctuate}
\usepackage{pifont}  % Dingbats
\usepackage{tcolorbox}
\tcbset{colback=white, size=title, boxsep=2mm}

%%% Colors
\usepackage[dvipsnames,svgnames,x11names]{xcolor}
\definecolor{bitcoin-orange}{RGB}{246, 145, 29}

%%% Math
\usepackage{amsmath}  % mostly for \qedhere
\usepackage{fixcmex}
% amsthm's proof environment conflicts with that of llncs
\let\lncsproof\proof
\let\lncsendproof\endproof
\let\proof\relax
\let\endproof\relax
\usepackage{amsthm}
\usepackage{mathtools}  % for \coloneq and \DeclarePairedDelimiter

%%% Notes and Todos
\NewDocumentCommand\newuser{m m m}{%
  \expandafter\NewDocumentCommand\csname #1note\endcsname{s O{} +m}{
    % Ensure that todos after paragraph headings are properly displayed
    \quitvmode%
    \texorpdfstring{%
      \todo[color=#3, inline, caption={}, ##2]{\textbf{#2:} ##3}%
    }{(Note by #2: ##3)}%
  }}
\ifnotes
  \usepackage{todonotes}
\else
  \usepackage[disable]{todonotes}
\fi

\iflabels
  \usepackage[notref,notcite,color]{showkeys}
\fi

%%% Bibliography
\ifbibtex
  \PassOptionsToPackage{backend=bibtex}{biblatex}
\fi
\PassOptionsToPackage{
  date=year,
  maxnames=3,
  minnames=3,
}{biblatex}
\ifcameraready
  \usepackage[
  style=biblatex-lncs/lncs,
  ]{biblatex}
  % Disable shorthands, see https://github.com/plk/biblatex/issues/1427
  \DeclareFieldInputHandler{shorthand}{\def\NewValue{}}
\else
  \usepackage[
  style=alphabetic,
  maxbibnames=15,
  minbibnames=15,
  ]{biblatex}
\fi

%%% cryptobib
% The files are supposed to be found in TEXMFHOME, see README.md. We'd
% prefer to specify subdirs (i.e., {cryptobib/abbrev3.bib} and
% {cryptobib/crypto.bib}) but texlab doesn't like this, see
% https://github.com/latex-lsp/texlab/issues/1406. Note that, while
% export and export_crossref both ship the abbrevX.bib files, these are
% identical, so there's no danger of confusion, even if the both are in
% TEXMFHOME (as long as both of them are updated in sync).
%
% "crypto.bib" will be treated specially: We use the biber-wrapper.sh
% script to extract the cited entries from crypto.bib into a temporary
% bib file and then call biber on it, to avoid that biber takes very
% long to process the huge crypto.bib. All of this should happen
% automatically and transparently if you use latexmk.
\addbibresource{abbrev3.bib}
\addbibresource{crypto.bib}

%%% Local bibliographies
\addbibresource{add.bib}

%%% Source maps (there must be only a single \DeclareSourcemap)
\DeclareSourcemap{
  \maps[datatype=bibtex]{
    % Use proper "eprint" fields for IACR Cryptology Archive
    \map{
      \step[fieldsource=howpublished, match=\regexp{\ACryptology\x20ePrint\x20Archive,\x20Report\x20(\d+)/(\d+)\z}, final]
      \step[fieldset=eprint, fieldvalue={$1/$2}]
      \step[fieldset=eprinttype, fieldvalue={iacr}]
      \step[fieldset=howpublished, null]
    }
    \map{
      \step[fieldsource=url, match=\regexp{https://eprint\.iacr\.org/(\d+)/(\d+)}, final]
      \step[fieldset=eprinttype, fieldvalue={iacr}]
      \step[fieldset=eprint, fieldvalue={$1/$2}]
      \step[fieldset=url, null]
    }
    % In, e.g., "CRYPTO 2019, Part II", remove ", Part II"
    \map{
      \step[fieldsource=booktitle, match=\regexp{(.*),\x20Part~I+}, replace={$1}, final]
    }
  }
}

%%% Printing ePrint identifiers
\newcommand\iacreprintname{Cryptology ePrint Archive}
%% Shorter alternative:
% \newcommand\iacreprintname{IACR ePrint}
% TODO Consider just "\textsc{IACR}" (like for URL and DOI).
\DeclareFieldFormat{eprint:iacr}{%
  \iacreprintname\addcolon\space
  \ifhyperref
    {\href{https://eprint.iacr.org/#1}{%
       \nolinkurl{#1}%
       \iffieldundef{eprintclass}
         {}
         {\addspace\texttt{\mkbibbrackets{\thefield{eprintclass}}}}}}
    {\nolinkurl{#1}%
     \iffieldundef{eprintclass}
       {}
       {\addspace\texttt{\mkbibbrackets{\thefield{eprintclass}}}}}}

%%% Save space in references
\AtEveryBibitem{
  % See Section 2.2.2 in the BibLaTeX manual for the field types
  \unless\iffull
    \clearfield{doi}
  \fi
  \clearlist{location}
  \clearname{editor}
  \clearfield{pages}
  \ifentrytype{inproceedings}{
      \clearfield{year}
      \clearfield{volume}
      \clearlist{publisher}
      \clearfield{series}
    }{}
}

%%% hyperref
\unless\ifcameraready
  \PassOptionsToPackage{pdfusetitle}{hyperref}
\fi
\usepackage{hyperref}
\hypersetup{
  hypertexnames=false,
}
\unless\ifcameraready
  \hypersetup{
    colorlinks=true,
    allcolors=blue,
    bookmarksopen,
  }
\usepackage{bookmark}
\fi

%%% Cross-references
\usepackage[capitalize, nameinlink]{cleveref}

% Use en-dash instead of " to~" for ranges.
\newcommand{\crefrangeconjunction}{--}
% Omit the word "equation" except at the start of a sentence.
\crefname{equation}{}{}
\Crefname{equation}{Equation}{Equations}
% \crefrangeconjunction is not sufficient for equations because
% the en dash will wrongly be in italic when the surrounding text is.
% So we'll need to provide full low-level definitions for range formats.
\crefrangeformat{equation}{\textup{#3(#1)#4--#5(#2)#6}}
\crefrangemultiformat{equation}{\textup{#3(#1)#4--#5(#2)#6}}%
  { and \textup{#3(#1)#4--#5(#2)#6}}%
  {, \textup{#3(#1)#4--#5(#2)#6}}%
  {, and \textup{#3(#1)#4--#5(#2)#6}}
\Crefrangeformat{equation}{Equations~\textup{#3(#1)#4--#5(#2)#6}}
\Crefrangemultiformat{equation}{Equations~\textup{#3(#1)#4--#5(#2)#6}}%
  { and \textup{#3(#1)#4--#5(#2)#6}}%
  {, \textup{#3(#1)#4--#5(#2)#6}}%
  {, and \textup{#3(#1)#4--#5(#2)#6}}%
% Force "line" and "item" to be lowercase.
% TODO Should we also just omit "item"?
\crefname{line}{line}{lines}
\Crefname{line}{Line}{Lines}
\crefname{enumi}{item}{items}
\Crefname{enumi}{Item}{Items}

%%% Alternative for cross-references
% \usepackage{zref-clever}
% \zcsetup{cap}
% % Replacement for \namecref
% \newcommand{\zcnameref}[1]{\zcref*[noref,nocap]{#1}}
% \zcRefTypeSetup{assumption}{
%   Name-sg = Assumption ,
%   name-sg = assumption ,
%   Name-pl = Assumptions ,
%   name-pl = assumptions ,
% }
% \zcRefTypeSetup{equation}{
%   abbrev = true ,
% }

%%% Additional theorem-like environments
\newtheorem{assumption}{Assumption}
\Crefname{assumption}{Assumption}{Assumptions}
\newtheorem{construction}{Construction}
\Crefname{construction}{Construction}{Constructions}

%%% Cryptocode
%%% TODO Extract this into a "mycryptocode.sty" package
\WarningFilter*[theH]{latex}{Command `\string\the}%
\ActivateWarningFilters[theH]
\usepackage[
  lambda,
  advantage,
  operators,
  adversary,
  landau,
  probability,
  sets,
  % notions,
  % logic,
  % ff,
  % mm,
  % primitives,
  % oracles,
  events,
  % complexity,
  asymptotics,
  keys,
]{cryptocode}
\DeactivateWarningFilters[theH]

% Better version of \pcfixcleveref
% (see https://github.com/arnomi/cryptocode/pull/15)
\IfPackageLoadedTF{cleveref}{
  \AtBeginDocument{
    \pcfixhyperref%
    \makeatletter
    \crefalias{@pclinenumber}{line}%
    \makeatother
    % TODO Consider further improvements for the interaction between
    % crytocode and cleveref, e.g., referencing games, see: https://tex.stackexchange.com/questions/623163/cryptocode-cref-should-link-to-a-game-and-write-its-name/623196#623196
  }
}{}

% Fix \gamechange to expect math mode contents
% (see https://github.com/arnomi/cryptocode/pull/21 )
\renewcommand{\gamechange}[2][gamechangecolor]{%
  {\setlength{\fboxsep}{0pt}\ifmmode%
      \mathchoice{%
        \colorbox{#1}{$\displaystyle#2$}%
      }{%
        \colorbox{#1}{$#2$}%
      }{%
        \colorbox{#1}{$\scriptstyle#2$}%
      }{%
        \colorbox{#1}{$\scriptscriptstyle#2$}%
      }%
    \else{#2}\fi}%
}

% Improved paired delimiters
% Usage: \abs{x} for auto-scaling, or \abs[\bigg] for manual scaling
\makeatletter
\RenewDocumentCommand\floor{om}{\IfValueTF{#1}{\pc@floor[#1]{#2}}{\pc@floor*{#2}}}
\RenewDocumentCommand\ceil{om}{\IfValueTF{#1}{\pc@ceil[#1]{#2}}{\pc@ceil*{#2}}}
\RenewDocumentCommand\Angle{om}{\IfValueTF{#1}{\pc@Angle[#1]{#2}}{\pc@Angle*{#2}}}
\RenewDocumentCommand\abs{om}{\IfValueTF{#1}{\pc@abs[#1]{#2}}{\pc@abs*{#2}}}
\RenewDocumentCommand\norm{om}{\IfValueTF{#1}{\pc@norm[#1]{#2}}{\pc@norm*{#2}}}
\DeclarePairedDelimiter{\pc@bracks}{\lbrack}{\rbrack}
\NewDocumentCommand\bracks{om}{\IfValueTF{#1}{\pc@bracks[#1]{#2}}{\pc@bracks*{#2}}}
\NewDocumentCommand\pr{om}{\Pr\bracks[#1]{#2}}
\makeatother

%%% Append "." to subsubsection and paragraph headings
\let\llncssubsubsection\subsubsection
\renewcommand{\subsubsection}[1]{\llncssubsubsection{#1.}}
\let\llncsparagraph\paragraph
\renewcommand{\paragraph}[1]{\llncsparagraph{#1.}}


\input{macros.tex}


%%% Title
%
% Springer wants:
% All words in titles should be capitalized except for conjunctions, prepositions
% (e.g. on, of, by, and, or, but, from, with, without, under), and definite/indefinite
% articles (the, a, an), unless they appear at the beginning. Formula letters are
% typeset as in the text.
%
% Hint: https://titlecaseconverter.com/
\title{\texorpdfstring{%
    My Title with Manual Line Breaks\\ and Some Special Chars like $\Lambda$%
  }{% Title for PDF metadata and bookmarks:
    My Title with Manual Line Breaks and Some Special Chars like Î›%
  }
}

%%% Authors
\unless\ifanonymous
  \unless\ifcameraready
    \RenewDocumentCommand\email{m}{\href{mailto:#1}{\texttt{\textcolor{black}{#1}}}}
    \RenewDocumentCommand\orcidID{m}{}
  \fi
  \author{\texorpdfstring{%
      Alice Author\inst{1}\orcidID{0000-0000-0000-0000}
      \and Bob Author\inst{2}\orcidID{0000-0000-0000-0000}
    }{% Authors for PDF metadata and bookmarks:
      Alice Author;
      Bob Author
    }}
  \institute{%
    Some Institute
    \and Some University
  }
\else
  \ifspace
    \author{\vspace{-4ex}}\institute{}
  \fi
\fi

%%% Notes and Todos
% Usage: \newuser{a}{Alice}{orange!20}
%
% The "!20" suffix creates a mix of 20% of the preceding color and 80%
% white. See https://latexcolor.com/ for predefined colors.
\newuser{a}{Alice}{orange!20}
\newuser{b}{Bob}{olive!20}

\begin{document}

\maketitle
\iffull
  \begin{center}
    \today
  \end{center}
\fi

%%% Abstract
\begin{abstract}
  \input{abstract.tex}
\end{abstract}

%%% Keywords
\ifcameraready
  \keywords{a keyword \and another one \and keywords are separated with \texttt{\textbackslash{}and}}
\fi

%%% Table of Contents
\iffull\ifcameraready
  \tableofcontents
  \clearpage
\fi\fi

%%% Uncomment this for usage notes on this LaTeX template
\input{../README-TEMPLATE.tex}

\input{intro.tex}
\input{prelim.tex}

%%% Appendix
\appendix
\crefalias{section}{appendix}

\section{An Appendix}\label{sec:test-appendix}
Many people don't follow this rule, but consider putting the appendix before the references.
The idea is that the references will be easy to find: They're always at the end.

%%% Acknowledgements
% \section*{Acknowledgements}
% We thank...

%%% Changelog
\iffull
  \phantomsection
  \addcontentsline{toc}{section}{Changelog}

  \section*{Changelog}\label{sec:changelog}
  \begin{description}
    \item[2022-03-30]\
          \begin{itemize}
            \item First public draft.
          \end{itemize}
  \end{description}
  % TODO Why is spacing wrong without this?
  \vspace{-2em}
\fi

%%% Bibliography
\phantomsection
\addcontentsline{toc}{section}{References}
\printbibliography\label{sec:bib}

\end{document}
