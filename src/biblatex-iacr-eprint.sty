%% biblatex-iacr-eprint.sty
%% Copyright Tim Ruffing and contributors
%% SPDX-License-Identifier: LPPL-1.3c+
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   https://www.latex-project.org/lppl.txt
% and version 1.3c or later is part of all distributions of LaTeX
% version 2008 or later.
%
% This work has the LPPL maintenance status `maintained'.
%
% The Current Maintainer of this work is:
%   Tim Ruffing <me@real-or-random.org>
%
% Please report issues at:
%   https://github.com/real-or-random/crypto-latex-template
%
% This work consists of this file.

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{biblatex-iacr-eprint}[2025-06-16 v1.0 IACR ePrints in BibLaTeX]

\let\ifbiblatexiacreprint@fullname\iffalse
\DeclareOption{fullname}{\let\ifbiblatexiacreprint@fullname\dfiftrue}
\ProcessOptions\relax

\RequirePackage{biblatex}[2018-02-20]  % v3.11, support for multiple \DeclareSourcemap

%%% Printing ePrint identifiers
\ifbiblatexiacreprint@fullname
  \newcommand\iacreprintname{Cryptology ePrint Archive\addcolon}
\else
  % Small caps acronym like "URL" and "DOI"
  \newcommand\iacreprintname{\mkbibacro{IACR}\addcolon}
\fi
%% Alternatives:
% \newcommand\iacreprintname{Cryptology ePrint Archive, Report}  % as in cryptobib
% \newcommand\iacreprintname{IACR ePrint\addcolon}
\DeclareFieldFormat{eprint:iacr}{%
  \iacreprintname\space%
  \ifhyperref
    {\href{https://eprint.iacr.org/#1}{%
       \nolinkurl{#1}%
       \iffieldundef{eprintclass}
         {}
         {\addspace\texttt{\mkbibbrackets{\thefield{eprintclass}}}}}}
    {\nolinkurl{#1}%
     \iffieldundef{eprintclass}
       {}
       {\addspace\texttt{\mkbibbrackets{\thefield{eprintclass}}}}}}

%%% Convert "howpublished" and "url" fields referring to IACR eprints
%%% (e.g., as in crypto.bib) to proper BibLaTeX "eprint" fields
\DeclareSourcemap{
  \maps[datatype=bibtex]{
    \map{
      \step[fieldsource=howpublished, match=\regexp{\ACryptology\x20ePrint\x20Archive,\x20Report\x20(\d+)/(\d+)\z}, final]
      \step[fieldset=eprint, fieldvalue={$1/$2}]
      \step[fieldset=eprinttype, fieldvalue={iacr}]
      \step[fieldset=howpublished, null]
    }
    \map{
      \step[fieldsource=url, match=\regexp{https://eprint\.iacr\.org/(\d+)/(\d+)}, final]
      \step[fieldset=eprinttype, fieldvalue={iacr}]
      \step[fieldset=eprint, fieldvalue={$1/$2}]
      \step[fieldset=url, null]
    }
  }
}
