%% cryptocode-tweaked.sty
%% Copyright Tim Ruffing and contributors
%% SPDX-License-Identifier: LPPL-1.3c+
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   https://www.latex-project.org/lppl.txt
% and version 1.3c or later is part of all distributions of LaTeX
% version 2008 or later.
%
% This work has the LPPL maintenance status `maintained'.
%
% The Current Maintainer of this work is:
%   Tim Ruffing <me@real-or-random.org>
%
% Please report issues at:
%   https://github.com/real-or-random/crypto-latex-template
%
% This work consists of this file.

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{cryptocode-tweaked}[2025-06-16 v1.0 cryptocode with tweaks and fixes]

\RequirePackage{silence}
\RequirePackage{mathtools}[2004-06-25]  % \DeclarePairedDelimiter
\RequirePackage{etoolbox}[2011-01-03]  % \AtBeginEnvironment

% Load cryptocode but suppress some warnings
% (see https://github.com/arnomi/cryptocode/issues/28)
\WarningFilter*[cryptocode-theH]{latex}{Command `\string\the}%
\ActivateWarningFilters[cryptocode-theH]
\RequirePackageWithOptions{cryptocode}
\DeactivateWarningFilters[cryptocode-theH]

% Better version of \pcfixcleveref
% (see https://github.com/arnomi/cryptocode/pull/15)
\AtBeginDocument{
  \IfPackageLoadedTF{cleveref}{
    \pcfixhyperref%
    \crefalias{@pclinenumber}{line}%
    % TODO Consider further improvements for the interaction between
    % crytocode and cleveref, e.g., referencing games, see: https://tex.stackexchange.com/questions/623163/cryptocode-cref-should-link-to-a-game-and-write-its-name/623196#623196
  }{}
}

% Fix \gamechange to expect math mode contents
% (see https://github.com/arnomi/cryptocode/pull/21 )
\renewcommand{\gamechange}[2][gamechangecolor]{%
  {\setlength{\fboxsep}{0pt}\ifmmode%
      \mathchoice{%
        \colorbox{#1}{$\displaystyle#2$}%
      }{%
        \colorbox{#1}{$#2$}%
      }{%
        \colorbox{#1}{$\scriptstyle#2$}%
      }{%
        \colorbox{#1}{$\scriptscriptstyle#2$}%
      }%
    \else{#2}\fi}%
}

% Improved paired delimiters
% Usage: \abs{x} for auto-scaling, or \abs[\bigg] for manual scaling
\RenewDocumentCommand\floor{om}{\IfValueTF{#1}{\pc@floor[#1]{#2}}{\pc@floor*{#2}}}
\RenewDocumentCommand\ceil{om}{\IfValueTF{#1}{\pc@ceil[#1]{#2}}{\pc@ceil*{#2}}}
\RenewDocumentCommand\Angle{om}{\IfValueTF{#1}{\pc@Angle[#1]{#2}}{\pc@Angle*{#2}}}
\RenewDocumentCommand\abs{om}{\IfValueTF{#1}{\pc@abs[#1]{#2}}{\pc@abs*{#2}}}
\RenewDocumentCommand\norm{om}{\IfValueTF{#1}{\pc@norm[#1]{#2}}{\pc@norm*{#2}}}
\DeclarePairedDelimiter{\pc@bracks}{\lbrack}{\rbrack}
\NewDocumentCommand\bracks{om}{\IfValueTF{#1}{\pc@bracks[#1]{#2}}{\pc@bracks*{#2}}}
\NewDocumentCommand\pr{om}{\Pr\bracks[#1]{#2}}

% Add padding to boxes in "boxed" stacks
% Usage: \setlength{\pcstackboxedsep}{2mm}  % defaults to 0
\newlength{\pcstackboxedsep}
\AtBeginEnvironment{pchstack}{\setlength{\fboxsep}{\pcstackboxedsep}}
\AtBeginEnvironment{pcvstack}{\setlength{\fboxsep}{\pcstackboxedsep}}
